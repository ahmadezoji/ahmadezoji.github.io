<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Form</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      padding: 16px;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
    }
    
    h3 {
      margin-bottom: 20px;
      color: var(--tg-theme-text-color, #000000);
      font-size: 20px;
      font-weight: 600;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
      color: var(--tg-theme-text-color, #000000);
    }
    
    .required::after {
      content: " *";
      color: #e74c3c;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      border-radius: 8px;
      font-size: 16px;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--tg-theme-button-color, #0088cc);
    }
    
    select[multiple] {
      height: 120px;
      padding: 8px;
    }
    
    select[multiple] option {
      padding: 8px;
      margin: 2px 0;
      border-radius: 4px;
    }
    
    select[multiple] option:checked {
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    
    .hint {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
      margin-top: 4px;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: var(--tg-theme-hint-color, #999);
    }
    
    .loading.active {
      display: block;
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }
    
    .error-message.active {
      display: block;
    }
    
    .spacer {
      height: 80px;
    }
  </style>
</head>
<body>
  <div class="error-message" id="errorMessage"></div>
  
  <h3>üìã Profile Information</h3>
  
  <form id="profileForm">
    <div class="form-group">
      <label class="required">Name</label>
      <input type="text" id="name" placeholder="Enter your first name" required />
    </div>
    
    <div class="form-group">
      <label class="required">Surname</label>
      <input type="text" id="surname" placeholder="Enter your last name" required />
    </div>
    
    <div class="form-group">
      <label class="required">Email</label>
      <input type="email" id="email" placeholder="your.email@example.com" required />
    </div>
    
    <div class="form-group">
      <label>Platforms</label>
      <select id="platforms" multiple>
        <option>freelancer</option>
        <option>upwork</option>
        <option>fiverr</option>
        <option>toptal</option>
      </select>
      <div class="hint">Hold Ctrl/Cmd to select multiple</div>
    </div>
    
    <div class="form-group">
      <label>Positions</label>
      <select id="positions" multiple>
        <option>front developer</option>
        <option>back developer</option>
        <option>fullstack developer</option>
        <option>data scientist</option>
        <option>devops engineer</option>
        <option>mobile developer</option>
      </select>
      <div class="hint">Hold Ctrl/Cmd to select multiple</div>
    </div>
    
    <div class="form-group">
      <label>Skills</label>
      <input type="text" id="skills" placeholder="e.g., JavaScript, Python, React" />
      <div class="hint">Comma separated values</div>
    </div>
    
    <div class="form-group">
      <label>Hourly Rate ($)</label>
      <input type="number" id="hourly_rate" min="0" step="1" placeholder="e.g., 50" />
    </div>
    
    <div class="form-group">
      <label>Fixed Rate Minimum ($)</label>
      <input type="number" id="fixed_rate_min" min="0" step="1" placeholder="e.g., 100" />
    </div>
    
    <div class="form-group">
      <label>Fixed Rate Maximum ($)</label>
      <input type="number" id="fixed_rate_max" min="0" step="1" placeholder="e.g., 5000" />
    </div>
    
    <div class="form-group">
      <label>Currency</label>
      <select id="currency">
        <option>USD</option>
        <option>EUR</option>
        <option>GBP</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Availability</label>
      <select id="availability">
        <option>part-time</option>
        <option>full-time</option>
        <option>hourly</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Experience Level</label>
      <select id="experience_level">
        <option>entry</option>
        <option>intermediate</option>
        <option>expert</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Location</label>
      <select id="location">
        <option>remote</option>
        <option>on-site</option>
        <option>hybrid</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Languages</label>
      <select id="languages" multiple>
        <option>English</option>
        <option>Spanish</option>
        <option>French</option>
        <option>German</option>
        <option>Chinese</option>
      </select>
      <div class="hint">Hold Ctrl/Cmd to select multiple</div>
    </div>
    
    <div class="form-group">
      <label>Experience</label>
      <textarea id="experience" rows="4" placeholder="Describe your professional experience..."></textarea>
    </div>
  </form>
  
  <div class="loading" id="loading">
    <p>üì§ Sending your profile...</p>
  </div>
  
  <div class="spacer"></div>
  
  <script>
    // Initialize Telegram WebApp
    const tg = window.Telegram.WebApp;
    
    console.log('üöÄ Telegram WebApp initialized');
    console.log('üì± WebApp version:', tg.version);
    console.log('üíª Platform:', tg.platform);
    console.log('üé® Theme:', tg.colorScheme);
    
    // Check if WebApp API is supported
    if (!tg.initDataUnsafe || !tg.version) {
      showError('‚ö†Ô∏è Please update your Telegram app to use this feature');
    }
    
    // Expand the WebApp to full height
    tg.expand();
    
    // Tell Telegram the WebApp is ready
    tg.ready();
    
    // Apply Telegram theme colors
    document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
    document.body.style.color = tg.themeParams.text_color || '#000000';
    
    // Helper function to show errors
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('active');
      setTimeout(() => {
        errorEl.classList.remove('active');
      }, 5000);
    }
    
    // Function to get multi-select values
    function getMultiSelect(id) {
      const select = document.getElementById(id);
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }
    
    // Function to collect form data
    function collectFormData() {
      const profile = {
        type: "profile",
        name: document.getElementById("name").value.trim(),
        surname: document.getElementById("surname").value.trim(),
        email: document.getElementById("email").value.trim(),
        platforms: getMultiSelect("platforms"),
        positions: getMultiSelect("positions"),
        skills: document.getElementById("skills").value.trim(),
        hourly_rate: document.getElementById("hourly_rate").value,
        fixed_rate_min: document.getElementById("fixed_rate_min").value,
        fixed_rate_max: document.getElementById("fixed_rate_max").value,
        currency: document.getElementById("currency").value,
        availability: document.getElementById("availability").value,
        experience_level: document.getElementById("experience_level").value,
        location: document.getElementById("location").value,
        languages: getMultiSelect("languages"),
        experience: document.getElementById("experience").value.trim()
      };
      return profile;
    }
    
    // Validate form
    function validateForm() {
      const name = document.getElementById("name").value.trim();
      const surname = document.getElementById("surname").value.trim();
      const email = document.getElementById("email").value.trim();
      
      if (!name) {
        showError("‚ùå Please enter your name");
        return false;
      }
      
      if (!surname) {
        showError("‚ùå Please enter your surname");
        return false;
      }
      
      if (!email) {
        showError("‚ùå Please enter your email");
        return false;
      }
      
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError("‚ùå Please enter a valid email address");
        return false;
      }
      
      return true;
    }
    
    // Function to send data
    function sendProfileData() {
      console.log('üìù Validating form...');
      
      if (!validateForm()) {
        return;
      }
      
      const profile = collectFormData();
      const jsonData = JSON.stringify(profile);
      
      console.log('‚úÖ Form validated successfully');
      console.log('üì¶ Profile data:', profile);
      console.log('üìè Data length:', jsonData.length, 'bytes');
      
      // Show loading indicator
      document.getElementById('loading').classList.add('active');
      document.getElementById('profileForm').style.opacity = '0.5';
      
      try {
        // Send data to bot with button text for better tracking
        console.log('üì§ Sending data to Telegram...');
        tg.sendData(jsonData);
        
        // Show success message after a short delay
        setTimeout(() => {
          console.log('‚úÖ Data sent successfully!');
          tg.showAlert("‚úÖ Profile submitted successfully!", () => {
            tg.close();
          });
        }, 500);
        
      } catch (error) {
        console.error('‚ùå Error sending data:', error);
        document.getElementById('loading').classList.remove('active');
        document.getElementById('profileForm').style.opacity = '1';
        showError('‚ùå Failed to send profile. Please try again.');
        tg.showAlert("‚ùå Error: " + error.message);
      }
    }
    
    // Setup MainButton
    tg.MainButton.setText("üíæ Submit Profile");
    tg.MainButton.color = tg.themeParams.button_color || '#0088cc';
    tg.MainButton.textColor = tg.themeParams.button_text_color || '#ffffff';
    tg.MainButton.show();
    
    // Handle MainButton click
    tg.MainButton.onClick(function() {
      console.log('üîò MainButton clicked');
      sendProfileData();
    });
    
    // Also handle form submission (backup method)
    document.getElementById("profileForm").onsubmit = function(e) {
      e.preventDefault();
      console.log('üìù Form submitted via submit event');
      sendProfileData();
    };
    
    // Enable/disable MainButton based on required fields
    const requiredFields = ['name', 'surname', 'email'];
    
    function updateMainButtonState() {
      const allFilled = requiredFields.every(id => {
        const value = document.getElementById(id).value.trim();
        return value !== '';
      });
      
      if (allFilled) {
        tg.MainButton.enable();
        tg.MainButton.setParams({
          color: tg.themeParams.button_color || '#0088cc'
        });
      } else {
        tg.MainButton.disable();
        tg.MainButton.setParams({
          color: '#cccccc'
        });
      }
    }
    
    requiredFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      field.addEventListener('input', updateMainButtonState);
      field.addEventListener('blur', updateMainButtonState);
    });
    
    // Initially disable MainButton until required fields are filled
    tg.MainButton.disable();
    tg.MainButton.setParams({ color: '#cccccc' });
    
    // Helper to set value for input/select/textarea
    function setFieldValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      
      if (el.tagName === "SELECT" && el.multiple && Array.isArray(value)) {
        Array.from(el.options).forEach(opt => {
          opt.selected = value.includes(opt.value);
        });
      } else if (el.type === "checkbox" || el.type === "radio") {
        el.checked = !!value;
      } else {
        el.value = value ?? '';
      }
    }

    // Parse profile from URL and fill form fields
    function fillFormFromProfile() {
      const params = new URLSearchParams(window.location.search);
      const profileStr = params.get('profile');
      
      if (!profileStr) {
        console.log('‚ÑπÔ∏è No profile data in URL - showing empty form');
        return;
      }
      
      try {
        console.log('üì• Loading profile data from URL...');
        const profile = JSON.parse(decodeURIComponent(profileStr));
        console.log('‚úÖ Profile loaded:', profile);
        
        setFieldValue("name", profile.name || '');
        setFieldValue("surname", profile.surname || '');
        setFieldValue("email", profile.email || '');
        setFieldValue("platforms", profile.platforms || []);
        setFieldValue("positions", profile.positions || []);
        setFieldValue("skills", profile.skills || '');
        setFieldValue("hourly_rate", profile.hourly_rate || '');
        setFieldValue("fixed_rate_min", profile.fixed_rate_min || '');
        setFieldValue("fixed_rate_max", profile.fixed_rate_max || '');
        setFieldValue("currency", profile.currency || 'USD');
        setFieldValue("availability", profile.availability || 'part-time');
        setFieldValue("experience_level", profile.experience_level || 'entry');
        setFieldValue("location", profile.location || 'remote');
        setFieldValue("languages", profile.languages || []);
        setFieldValue("experience", profile.experience || '');
        
        // Update MainButton state after loading profile
        updateMainButtonState();
        
        console.log('‚úÖ Form filled with profile data');
      } catch (e) {
        console.error("‚ùå Failed to parse profile from URL:", e);
        showError('‚ö†Ô∏è Could not load profile data');
      }
    }

    // Call fillFormFromProfile on page load
    window.addEventListener('DOMContentLoaded', fillFormFromProfile);
    
    // Handle back button
    tg.BackButton.onClick(function() {
      tg.close();
    });
    
    console.log('‚úÖ Profile form ready!');
  </script>
</body>
</html>
