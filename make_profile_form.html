<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile Form</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    select[multiple] {
      height: 100px;
    }
  </style>
</head>
<body>
  <h3>Enter Profile Details</h3>
  <form id="profileForm">
    <label>Name: 
      <input type="text" id="name" required />
    </label>
    
    <label>Surname: 
      <input type="text" id="surname" required />
    </label>
    
    <label>Email: 
      <input type="email" id="email" required />
    </label>
    
    <label>Platforms:
      <select id="platforms" multiple>
        <option>freelancer</option>
        <option>upwork</option>
        <option>fiverr</option>
        <option>toptal</option>
      </select>
    </label>
    
    <label>Positions:
      <select id="positions" multiple>
        <option>front developer</option>
        <option>back developer</option>
        <option>fullstack developer</option>
        <option>data scientist</option>
        <option>devops engineer</option>
        <option>mobile developer</option>
      </select>
    </label>
    
    <label>Skills: 
      <input type="text" id="skills" placeholder="Comma separated" />
    </label>
    
    <label>Hourly Rate: 
      <input type="number" id="hourly_rate" />
    </label>
    
    <label>Fixed Rate Min: 
      <input type="number" id="fixed_rate_min" />
    </label>
    
    <label>Fixed Rate Max: 
      <input type="number" id="fixed_rate_max" />
    </label>
    
    <label>Currency:
      <select id="currency">
        <option>USD</option>
        <option>EUR</option>
        <option>GBP</option>
      </select>
    </label>
    
    <label>Availability:
      <select id="availability">
        <option>part-time</option>
        <option>full-time</option>
        <option>hourly</option>
      </select>
    </label>
    
    <label>Experience Level:
      <select id="experience_level">
        <option>entry</option>
        <option>intermediate</option>
        <option>expert</option>
      </select>
    </label>
    
    <label>Location:
      <select id="location">
        <option>remote</option>
        <option>on-site</option>
        <option>hybrid</option>
      </select>
    </label>
    
    <label>Languages:
      <select id="languages" multiple>
        <option>English</option>
        <option>Spanish</option>
        <option>French</option>
        <option>German</option>
        <option>Chinese</option>
      </select>
    </label>
    
    <label>Experience: 
      <textarea id="experience" rows="4"></textarea>
    </label>
    
    <div style="height: 100px;"></div>
  </form>
  
  <script>
    // Initialize Telegram WebApp
    const tg = window.Telegram.WebApp;
    
    console.log('Telegram WebApp initialized:', tg);
    console.log('WebApp version:', tg.version);
    console.log('Platform:', tg.platform);
    
    // Expand the WebApp to full height
    tg.expand();
    
    // Tell Telegram the WebApp is ready
    tg.ready();
    
    // Function to collect form data
    function getMultiSelect(id) {
      return Array.from(document.getElementById(id).selectedOptions).map(opt => opt.value);
    }
    
    function collectFormData() {
      const profile = {
        name: document.getElementById("name").value,
        surname: document.getElementById("surname").value,
        email: document.getElementById("email").value,
        platforms: getMultiSelect("platforms"),
        positions: getMultiSelect("positions"),
        skills: document.getElementById("skills").value,
        hourly_rate: document.getElementById("hourly_rate").value,
        fixed_rate_min: document.getElementById("fixed_rate_min").value,
        fixed_rate_max: document.getElementById("fixed_rate_max").value,
        currency: document.getElementById("currency").value,
        availability: document.getElementById("availability").value,
        experience_level: document.getElementById("experience_level").value,
        location: document.getElementById("location").value,
        languages: getMultiSelect("languages"),
        experience: document.getElementById("experience").value
      };
      profile.type = "profile"; // Add this line
      return profile;
    }
    
    // Validate form
    function validateForm() {
      const name = document.getElementById("name").value;
      const surname = document.getElementById("surname").value;
      const email = document.getElementById("email").value;
      
      if (!name || !surname || !email) {
        tg.showAlert("Please fill in all required fields (Name, Surname, Email)");
        return false;
      }
      return true;
    }
    
    // Setup MainButton
    tg.MainButton.text = "Submit Profile";
    tg.MainButton.show();
    
    // Handle MainButton click
    tg.MainButton.onClick(function() {
      console.log('MainButton clicked');
      
      if (!validateForm()) {
        return;
      }
      
      const profile = collectFormData();
      const jsonData = JSON.stringify(profile);
      
      console.log('Sending data:', jsonData);
      console.log('Data length:', jsonData.length);
      
      // Send data to bot
      tg.sendData(jsonData);
      
      // The WebApp will close automatically after sendData
    });
    
    // Also handle form submission (backup method)
    document.getElementById("profileForm").onsubmit = function(e) {
      e.preventDefault();
      console.log('Form submitted via submit event');
      
      if (!validateForm()) {
        return;
      }
      
      const profile = collectFormData();
      const jsonData = JSON.stringify(profile);
      
      console.log('Sending data:', jsonData);
      tg.sendData(jsonData);
    };
    
    // Enable MainButton when form is valid
    const requiredFields = ['name', 'surname', 'email'];
    requiredFields.forEach(fieldId => {
      document.getElementById(fieldId).addEventListener('input', function() {
        const allFilled = requiredFields.every(id => document.getElementById(id).value.trim() !== '');
        if (allFilled) {
          tg.MainButton.enable();
        } else {
          tg.MainButton.disable();
        }
      });
    });
    
    // Initially disable MainButton until required fields are filled
    tg.MainButton.disable();
    
    // Helper to set value or default for input/select/textarea
    function setFieldValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.tagName === "SELECT" && el.multiple && Array.isArray(value)) {
        Array.from(el.options).forEach(opt => {
          opt.selected = value.includes(opt.value);
        });
      } else if (el.type === "checkbox" || el.type === "radio") {
        el.checked = !!value;
      } else {
        el.value = value ?? '';
      }
    }

    // Parse profile from URL and fill form fields
    function fillFormFromProfile() {
      const params = new URLSearchParams(window.location.search);
      const profileStr = params.get('profile');
      if (!profileStr) return;
      try {
        const profile = JSON.parse(decodeURIComponent(profileStr));
        setFieldValue("name", profile.name || '');
        setFieldValue("surname", profile.surname || '');
        setFieldValue("email", profile.email || '');
        setFieldValue("platforms", profile.platforms || []);
        setFieldValue("positions", profile.positions || []);
        setFieldValue("skills", profile.skills || '');
        setFieldValue("hourly_rate", profile.hourly_rate || '');
        setFieldValue("fixed_rate_min", profile.fixed_rate_min || '');
        setFieldValue("fixed_rate_max", profile.fixed_rate_max || '');
        setFieldValue("currency", profile.currency || 'USD');
        setFieldValue("availability", profile.availability || 'part-time');
        setFieldValue("experience_level", profile.experience_level || 'entry');
        setFieldValue("location", profile.location || 'remote');
        setFieldValue("languages", profile.languages || []);
        setFieldValue("experience", profile.experience || '');
      } catch (e) {
        console.error("Failed to parse profile from URL:", e);
      }
    }

    // Call fillFormFromProfile on page load
    window.addEventListener('DOMContentLoaded', fillFormFromProfile);
  </script>
</body>
</html>
